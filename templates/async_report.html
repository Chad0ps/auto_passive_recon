<!DOCTYPE html>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<link
  href="https://netdna.bootstrapcdn.com/bootstrap/3.1.0/css/bootstrap.min.css"
  rel="stylesheet"
  id="bootstrap-css"
/>
<script src="https://netdna.bootstrapcdn.com/bootstrap/3.1.0/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.4/jspdf.min.js"></script>
<link
  href="https://gitcdn.github.io/bootstrap-toggle/2.2.2/css/bootstrap-toggle.min.css"
  rel="stylesheet"
/>
<script src="https://gitcdn.github.io/bootstrap-toggle/2.2.2/js/bootstrap-toggle.min.js"></script>
<!------ Include the above in your HEAD tag ---------->

<html>
  <head>
    <title>Automated Report</title>
    <link rel="stylesheet" type="text/css" href="../static/styles.css" />
    <style type="text/css" media="print">
      .dontprint {
        display: none;
      }
    </style>
    <style>
      .progress {
        width: 100%;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <hr />
    <div
      style="width:30px; height: 30px; display: inline-block;
            vertical-align:top;"
    >
      <img
        src="https://www.onemedical.com/static/images/apple-touch-icon-180x180.png"
        style="max-width:100%;
                max-height:100%;"
      />
    </div>
    <h1 style="display: inline-block; vertical-align:top;">
      Passive Recon Report: {{ company_name }}
    </h1>

    <div class="dontprint">
      <hr />
      <h4><a target="_blank" href="/">Start Over</a></h4>
      <h4>
        To submit report, open the print module (âŒ˜P) and save as a PDF.<br />
        Email Security@ and we will get back to you shortly!
      </h4>
    </div>
    <hr />

    <!--<button onclick="start_long_task();">Start Long Calculation</button><br><br>-->
    <script src="//cdnjs.cloudflare.com/ajax/libs/nanobar/0.2.1/nanobar.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <div id="progress"></div>

    <div class="data-here"></div>

    <script>
      function start_long_task() {
        // add task status elements
        div = $(
          '<div id="progress" class="progress"><div></div><div>0%</div><div>...</div><div>&nbsp;</div></div><hr>'
        );
        $('#progress').append(div);
        // create a progress bar
        var nanobar = new Nanobar({
          bg: '#44f',
          target: div[0].childNodes[0],
        });
        // send ajax POST request to start background job
        $.ajax({
          type: 'POST',
          url: '/launch_recon',
          data: JSON.stringify({
            url: '{{DOMAIN}}',
            company_name: '{{company_name}}',
          }),
          contentType: 'application/json;charset=UTF-8',
          success: function(data, status, request) {
            status_url = request.getResponseHeader('Location');
            update_progress(status_url, nanobar, div[0]);
          },
          error: function() {
            alert('Unexpected error');
          },
        });
      }
      function update_progress(status_url, nanobar, status_div) {
        // send GET request to status URL
        $.getJSON(status_url, function(data) {
          // update UI
          percent = parseInt((data['current'] * 100) / data['total']);
          nanobar.go(percent);
          $(status_div.childNodes[1]).text(percent + '%');
          $(status_div.childNodes[2]).text(data['status']);

          if ('result' in data) {
            $('.data-here').html(data['result']);
          }

          console.log(data['state']);
          if (data['state'] == 'COMPLETED') {
            $('#progress').hide();
            $(status_div.childNodes[3]).text('Result: ' + data['state']);
          } else {
            setTimeout(function() {
              update_progress(status_url, nanobar, status_div);
            }, 2000);
          }
        });
      }

      start_long_task();
    </script>
    <!-- <button id="start-bg-job" onclick="start_long_task()">Start
            Long Calculation</button><br><br> -->
  </body>
</html>
